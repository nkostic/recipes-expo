# recipes-expo Setup Guide

Complete setup guide for development and production environments.

## Overview

This app uses three external services:
- **Clerk** — Authentication (sign-up, sign-in, user management)
- **Convex** — Backend database and serverless functions
- **Expo** — Build and deployment (EAS)

---

## Prerequisites

- Node.js v18+
- pnpm (`npm install -g pnpm`)
- Expo account ([expo.dev](https://expo.dev))
- Clerk account ([clerk.com](https://clerk.com))
- Convex account ([convex.dev](https://convex.dev))

---

## 1. Clerk Setup

### Development Environment

1. Go to [clerk.com](https://clerk.com) and create an account
2. Create a new application (e.g., "recipes-dev")
3. Choose authentication methods (Email, Google, Apple, etc.)
4. Go to **API Keys** in the sidebar
5. Copy the **Publishable key** (starts with `pk_test_`)

### Production Environment

1. Create a separate Clerk application (e.g., "recipes-prod")
2. Go to **API Keys**
3. Copy the **Publishable key** (starts with `pk_live_` for production)

### Configure JWT for Convex

This is **critical** — Convex needs to verify Clerk JWTs.

1. In Clerk dashboard, go to **JWT Templates**
2. Click **New template** → Select **Convex**
3. Keep the default settings:
   - Name: `convex`
   - Token lifetime: 60 seconds
   - Algorithm: RS256
4. Save the template
5. Copy the **Issuer URL** (looks like `https://your-app.clerk.accounts.dev`)

---

## 2. Convex Setup

### Development Environment

1. Go to [convex.dev](https://convex.dev) and create an account
2. Create a new project (e.g., "recipes-dev")
3. Install Convex CLI: `pnpm add -D convex`
4. Run `npx convex dev` — this will:
   - Prompt you to log in
   - Create `.env.local` with your deployment URL
   - Start the dev server and sync your schema

### Configure Clerk Integration in Convex

1. In Convex dashboard, go to **Settings** → **Environment Variables**
2. Add: `CLERK_JWT_ISSUER_DOMAIN` = your Clerk Issuer URL (from JWT template)
   - Example: `https://current-tahr-56.clerk.accounts.dev`
3. The `convex/auth.config.ts` file uses this variable

### Production Environment

1. In Convex dashboard, create a new project or use deployment settings
2. Go to **Deployments** and create a production deployment
3. Set the same environment variable: `CLERK_JWT_ISSUER_DOMAIN`
4. Note your production Convex URL (e.g., `https://your-prod.convex.cloud`)

---

## 3. Environment Variables

### Required Variables

| Variable | Description | Where to get it |
|----------|-------------|-----------------|
| `EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY` | Clerk public key | Clerk → API Keys |
| `EXPO_PUBLIC_CONVEX_URL` | Convex deployment URL | Convex dashboard or `.env.local` |
| `CONVEX_DEPLOYMENT` | Convex deployment name | Auto-generated by `convex dev` |

### Convex Server-Side (Dashboard)

| Variable | Description | Where to get it |
|----------|-------------|-----------------|
| `CLERK_JWT_ISSUER_DOMAIN` | Clerk issuer URL | Clerk → JWT Templates → Convex |

### File Structure

```
.env                    # Checked into git (safe public vars only, or gitignored)
.env.local              # Local overrides (gitignored) - created by convex dev
```

### Development `.env` Example

```bash
# Convex (auto-populated by `npx convex dev`)
CONVEX_DEPLOYMENT=dev:your-deployment-name
EXPO_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud

# Clerk (from your DEV Clerk app)
EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxxxxxxxxxxxx
```

### Production Environment Variables

For production builds via EAS:

```bash
# Set in eas.json or EAS Secrets
EXPO_PUBLIC_CONVEX_URL=https://your-prod-deployment.convex.cloud
EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_xxxxxxxxxxxxx
```

---

## 4. Local Development

### First-Time Setup

```bash
# 1. Clone and install
git clone <repo>
cd recipes-expo
pnpm install

# 2. Start Convex dev server (creates .env.local, syncs schema)
npx convex dev

# 3. In a new terminal, start Expo
pnpm start
```

### Running the App

```bash
# Start Convex (keep running in background)
npx convex dev

# Start Expo dev server
pnpm start

# Then press:
# i - iOS Simulator
# a - Android Emulator
# w - Web browser
# Or scan QR with Expo Go app
```

---

## 5. Production Build (EAS)

### One-Time Setup

```bash
# Install EAS CLI
npm install -g eas-cli

# Login to Expo
eas login

# Configure project (creates eas.json if not exists)
eas build:configure
```

### Configure Production Secrets

In EAS dashboard or via CLI:

```bash
eas secret:create --name EXPO_PUBLIC_CONVEX_URL --value "https://your-prod.convex.cloud"
eas secret:create --name EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY --value "pk_live_xxx"
```

Or set in `eas.json`:

```json
{
  "build": {
    "production": {
      "env": {
        "EXPO_PUBLIC_CONVEX_URL": "https://your-prod.convex.cloud",
        "EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY": "pk_live_xxxxxxxxxxxxx"
      }
    }
  }
}
```

### Deploy Convex to Production

```bash
# Deploy functions and schema to production
npx convex deploy --prod
```

### Build for App Stores

```bash
# iOS
eas build --platform ios --profile production

# Android
eas build --platform android --profile production

# Both
eas build --platform all --profile production
```

### Submit to App Stores

```bash
# iOS App Store
eas submit --platform ios

# Google Play Store
eas submit --platform android
```

---

## 6. Environment Checklist

### Development ✅

- [ ] Clerk dev app created
- [ ] Clerk JWT template for Convex configured
- [ ] Convex dev project created
- [ ] `CLERK_JWT_ISSUER_DOMAIN` set in Convex dashboard
- [ ] `.env` or `.env.local` has `EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY`
- [ ] `.env` or `.env.local` has `EXPO_PUBLIC_CONVEX_URL`
- [ ] `npx convex dev` runs without errors
- [ ] `pnpm start` runs and app loads

### Production ✅

- [ ] Clerk production app created (separate from dev)
- [ ] Clerk JWT template for Convex configured (production app)
- [ ] Convex production deployment created
- [ ] `CLERK_JWT_ISSUER_DOMAIN` set in Convex production environment
- [ ] EAS secrets configured with production keys
- [ ] `npx convex deploy --prod` successful
- [ ] EAS build completes

---

## Troubleshooting

### "Not authenticated" errors

1. Check `CLERK_JWT_ISSUER_DOMAIN` is set correctly in Convex dashboard
2. Ensure the JWT template in Clerk is named `convex`
3. Verify the issuer URL matches exactly (no trailing slash)

### Convex functions not updating

```bash
# Reset and resync
npx convex dev --once
```

### Clerk token issues

1. Clear app data/cache
2. Sign out and sign back in
3. Check Clerk dashboard for any blocked users

### Environment variables not loading

1. Restart Metro bundler: `npx expo start --clear`
2. Ensure variable names start with `EXPO_PUBLIC_` for client access
3. Check `.env` file is in project root

---

## Quick Reference

| Service | Dev Dashboard | Prod Dashboard |
|---------|--------------|----------------|
| Clerk | [dashboard.clerk.com](https://dashboard.clerk.com) | Same (switch apps) |
| Convex | [dashboard.convex.dev](https://dashboard.convex.dev) | Same (switch deployments) |
| Expo/EAS | [expo.dev](https://expo.dev) | Same |

---

## Security Notes

- Never commit `.env.local` or files containing secret keys
- Use `pk_test_` keys only in development
- Rotate keys if accidentally exposed
- Clerk secret keys (`sk_`) are never needed in the mobile app
